<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EchoChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0e12;color:#e7eef7}
    .card{max-width:520px;padding:22px 20px;border-radius:14px;background:#121826;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .title{font-size:18px;font-weight:700;margin:0 0 8px}
    .muted{opacity:.78;line-height:1.35;margin:0 0 14px}
    .row{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:#4aa3ff;box-shadow:0 0 0 6px rgba(74,163,255,.12)}
    a{color:#7ec3ff}
  </style>
</head>

<body>
  <div class="card">
    <h1 class="title">Reconnecting…</h1>
    <p class="muted">Attempting to restore your session (v{{ app_version }}). If this fails, you’ll be sent to login.</p>
    <div class="row"><span class="dot"></span><span class="muted" id="status">Refreshing session…</span></div>
    <p class="muted" style="margin-top:14px">If you’re stuck, <a href="/login">click here to login</a>.</p>
  </div>

  <script>
    function getCookie(name){
      try{
        const parts = document.cookie.split(';');
        for (const p of parts){
          const [k,v] = p.split('=');
          if (k && k.trim() === name) return decodeURIComponent((v||'').trim());
        }
      } catch(e) {}
      return '';
    }

    async function refresh(){
      const statusEl = document.getElementById('status');
      const csrf = getCookie('csrf_refresh_token');

      try{
        const res = await fetch('/token/refresh', {
          method: 'POST',
          credentials: 'include',
          headers: csrf ? {'X-CSRF-TOKEN': csrf} : {},
        });
        if (res.ok){
          statusEl.textContent = 'Session restored. Loading chat…';
          window.location.replace('/chat');
          return;
        }
        statusEl.textContent = 'Session could not be restored. Redirecting to login…';
        window.location.replace('/login');
      } catch (e){
        statusEl.textContent = 'Network error. Redirecting to login…';
        window.location.replace('/login');
      }
    }

    refresh();
  </script>
</body>
</html>
